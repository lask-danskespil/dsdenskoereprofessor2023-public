(function () {
	var bridge = falcon.game.bridge.getBridge();
	var load = bridge.loadScripts;

	// Game configuration load
	// loadJSON(paths.configPath).then(function (gameConfig) {
	bridge.getComputedPaths().then(function (paths) {
		bridge.getCurrentGameConfiguration().then(function (gameConfig) {
			gameConfig.frameworkPath = paths.frameworkPath;
			gameConfig.gamePath = paths.gamePath;

			loadGame(gameConfig);
		});
	});

	var loadGame = function (gameConfig) {
		var systemjsPath = gameConfig.frameworkPath + gameConfig.loader.systemjs;

		// Import utils (SystemJS)
		load([systemjsPath])
			.then(function () {
				var systemjsConfig = gameConfig.modules;
				systemjsConfig["baseURL"] = gameConfig.frameworkPath;

				SystemJS.config(systemjsConfig);
				System.set("falcon", System.newModule({ __useDefault: falcon }));
				System.set("@falcon/bridge", System.newModule({ __useDefault: falcon }));
				// Import game entry point

				Promise.all(
					Object.keys(systemjsConfig.paths).map(function (name) {
						return System.import(name);
					})
				)
					.then(function () {
						GDKRegisterGame();
						return SystemJS.import("@gdk/the-awesome-game");
					})
					.then(function (Game) {
						start(Game, gameConfig);
					});
			})
			.catch(function (e) {
				console.error(e);
			});
	};

	var start = function (Game, gameConfig) {
		var initCallback = function () {
			window.game.start();
		};
		window.game = new (Game.default || Game)(gameConfig);

		if (window.game.init && typeof window.game.init === "function") {
			window.game.init(initCallback);
		} else {
			initCallback();
		}
	};
})();
